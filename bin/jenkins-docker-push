#!/bin/sh

docker_build() {
  local tag="$1"; test $# -eq 0 || shift
  time docker build --pull -t "$tag" "$@"
}

docker_build_archive() {
  local tag="$1"; shift
  local context_root="${1:-.}"; test $# -eq 0 || shift
  local context_archive="$context_root"/target/app.tgz
  local pushinfopath='docker-push.info'
  test -s "$context_archive" || context_archive="$context_root"/app.tgz

  printf 'Building Docker image "%s"\nfrom context ' "$REPO_PREFIX_CS"
  if test -s "$context_archive"; then
    printf "archive at '%s'...\n\n" "$(readlink -f "$context_archive")"
    docker_build "$tag" "$@" - <"$context_archive" || return
    pushinfopath="$(dirname "$context_archive")/$pushinfopath"
    printf "CONTEXT_ROOT=$context_archive\nIMAGE=$tag\n" \
      > "$pushinfopath" || return
  else
    printf "dir at '%s'...\n\n" "$(readlink -f "$context_root")"
    docker_build "$tag" "$@" "$context_root" || return
    pushinfopath="$context_root/$pushinfopath"
    printf "CONTEXT_ROOT=$context_root\nIMAGE=$tag\n" \
      > "$pushinfopath" || return
  fi

}

jenkins_docker_push() {
  test $# -ge 2 || {
    printf 'Parameters:\n\nREPO_PREFIX\nUPSTREAM_JOB_NAME\n<UPSTREAM_BUILD_NUMBER>\n<CHANGESET>'
    return 1
  }

  local REPO_PREFIX="$(echo $1 | tr '[:upper:]' '[:lower:]')"; shift
  local UPSTREAM_JOB_NAME="$1"; test $# -gt 0 && shift
  local UPSTREAM_BUILD_NUMBER="${1:-$(id -nu)-at-$(hostname -s)}"; test $# -gt 0 && shift
  local CHANGESET="${1:-$(git rev-parse HEAD)}"

  REPO_PREFIX="$(echo $REPO_PREFIX:$UPSTREAM_JOB_NAME | tr '[:upper:]' '[:lower:]')."
  local REPO_PREFIX_BN="$(echo ${REPO_PREFIX}$UPSTREAM_BUILD_NUMBER | tr '[:upper:]' '[:lower:]')"
  local REPO_PREFIX_CS="$REPO_PREFIX_BN-$(printf '%.7s' "$CHANGESET")"

  docker_build_archive "$REPO_PREFIX_CS" || return
  docker tag "$REPO_PREFIX_CS" "$REPO_PREFIX_BN" || return
  docker tag "$REPO_PREFIX_CS" "${REPO_PREFIX}latest" || return

  echo "Pushing 3 tags..."
  docker push "${REPO_PREFIX}latest" || return
  docker push "$REPO_PREFIX_BN" || return
  docker push "$REPO_PREFIX_CS" || return

  cat <<EOF

To pull this image, type:
docker pull $REPO_PREFIX_CS


$0: Done.
EOF
}  

test "$DEBUG" && set -x
jenkins_docker_push "$@"
