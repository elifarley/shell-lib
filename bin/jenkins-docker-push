#!/bin/sh

docker_build() {
  local tag="$1"; test $# -eq 0 || shift
  time docker build --pull -t "$tag" "$@"
}

docker_build_archive() {
  local tag="$1"; shift
  local context_root="${1:-.}"; test $# -eq 0 || shift
  local context_archive="$context_root"/app.tgz

  if test -s "$context_archive"; then
    cat "$context_archive" | docker_build "$tag" "$@" - || return
  else
    docker_build "$tag" "$@" "$context_root" || return
  fi

}

jenkins_docker_push() {
  test $# -eq 4 || {
    printf 'Parameters:\n\nREPO_PREFIX\nUPSTREAM_JOB_NAME\nUPSTREAM_BUILD_NUMBER\nCHANGESET'
    return 1
  }

  local REPO_PREFIX="$1"; shift
  local UPSTREAM_JOB_NAME="$1"; shift
  local UPSTREAM_BUILD_NUMBER="$1"; shift
  local CHANGESET="$1"

  REPO_PREFIX="$REPO_PREFIX:$UPSTREAM_JOB_NAME."
  local REPO_PREFIX_BN="${REPO_PREFIX}$UPSTREAM_BUILD_NUMBER"
  local REPO_PREFIX_CS="$REPO_PREFIX_BN-$(printf '%.7s' "$CHANGESET")"

  echo "Building '$REPO_PREFIX_CS'..."
  docker_build_archive "$REPO_PREFIX_BN" || return
  docker tag "$REPO_PREFIX_BN" "$REPO_PREFIX_CS" || return
  docker tag "$REPO_PREFIX_BN" "${REPO_PREFIX}latest" || return

  echo "Pushing 3 tags..."
  docker push "${REPO_PREFIX}latest" || return
  docker push "$REPO_PREFIX_BN" || return
  docker push "$REPO_PREFIX_CS" || return

  cat <<EOF

To pull this image, type:
docker pull $REPO_PREFIX_CS


$0: Done.
EOF
}  

jenkins_docker_push "$@"
