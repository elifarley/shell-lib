#!/usr/bin/env bash

build_info() {
  printf 'BUILD_DATE="%s %s"\n' "$(date +'%F %T.%N')" "$(date +%Z)"
  echo "BUILD_URL='$BUILD_URL'"
  echo "DVCS_URL='$GIT_URL'"
  echo "DVCS_NODE='$GIT_COMMIT'"
  echo "DVCS_BRANCH='$GIT_BRANCH'"
}

archive_artifacts() {
  local project_root="$(readlink -f "${1:-.}")"; shift
  local archive_target; archive_target="$(readlink -f "${1:-.}")" || {
    echo "Invalid path: '$1'"
    return 1;
  }
  shift

  test -d "$archive_target"/target && archive_target="$archive_target"/target

  adir="$(mktemp -d -p "${TMPDIR:-/tmp}" shell-lib-"$JOB_NAME".XXXXXXX)"
  test -d "$adir" || return 1

  build_info >> "$project_root"/build-info.txt
  tar -zcvf "$adir"/app.tgz --exclude-ignore="$project_root"/.dockerignore \
    --exclude-vcs --exclude-backups --exclude-caches \
    -C "$project_root" "$@" && \
  mv "$adir"/app.tgz "$archive_target" && \
  rm -rf "$adir" || \
  { rm -rf "$adir"; return 1 ;}

}

test "$DEBUG" && set -x
archive_artifacts "$@"
